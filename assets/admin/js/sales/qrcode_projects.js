var default_context = `立書人        普匯金融科技股份有限公司 (以下簡稱甲方)
        (以下簡稱乙方)
    甲、乙雙方本著合作互惠精神，雙方約定合作條件如下，以資共同信守。

一、  雙方合意
本協議書由甲、乙雙方同意訂定，自雙方代表完成簽署時生效。本協議之增刪或修改，非經甲乙雙方以書面協議方式為之，不生效力。

二、  合作期間
自民國        年      月       日起算一年，於契約效力存續期間內，若雙方皆無以書面提供不續約之意思表示，則本契約自動續約一年。

三、  合作內容
1.  甲方提供乙方實名會員可辨認乙方身份之二維條碼（下稱 \"QR code\"），以供乙方分享其他使用者掃描註冊成為甲方之借款人會員。經掃描甲方提供乙方之QR code成為甲方借款人會員之第三人，首次於甲方之借貸平台網頁「inFlux普匯金融科技(https://www.influxfin.com/)」或普匯inFlux APP完成首貸即取得貸款，發放業務獎金規則如下：
(1) 依該筆放款收取之服務手續費提撥發放 %platform_fee% %以資獎勵。
(2) 依該筆放款收取之利息費用提撥 %interest% %以資獎勵，但須排出發生逾期之案件。
(3) 以上須扣除其他已發放之業務合作獎金。
2.  經掃描甲方提供乙方之QR code成為甲方借款人會員之第三人，首次於甲方之借貸平台網頁「inFlux普匯金融科技(https://www.influxfin.com/)」或普匯inFlux APP，就普匯之第三方資金提供者業務合作完成首貸即取得貸款，發放業務獎金規則如下：
(1) 個人金融產品，核發獎金新台幣 %collaboration_person% 元。
(2) 企業金融產品，核發獎金新台幣 %collaboration_enterprise% 元。
(3) 以上須扣除其他已發放之業務合作獎金。
3.  乙方應於甲方提供QR code前，註冊成為普匯會員，並完成相對應之實名認證。  
4.  業務獎金核發流程
(1) 甲方於每個月底統計業務獎金，並於隔月十號以email或其他電子形式通知乙方成功貸款獎金數額、勞務報酬單，並將獎金匯款至乙方於普匯之代收代付帳戶。乙方同意成功借款人數及金額以甲方統計為準。
(2) 本協議若因第七條所述原因終止，甲方給予乙方之業務獎金結算至終止日期。
5.  如甲方給付乙方獎金後，借款人有撤銷借款、借款後逾期或其他經甲方判定為借貸關係失效情事者，甲方得於下期獎金逕行扣除該筆獎金，乙方不得異議。
6.  若本條一項之第三人有產生逾期之情形，其逾期人數佔總借貸人數之5％，則乙方應向甲方報告並檢討相關辦法，且甲方有權終止與乙方之合作。
7.  乙方授權甲方，就乙方提供給甲方之相關資料製作勞務報酬單，相關資料內容包含但不限於身分證、生日、聯絡方式等等。
8.  除經甲方書面同意外，乙方不得以網際網路或其他電子方式公開傳輸、散布本協議書，否則甲方得逕行終止本協議並扣除因此方式推廣之獎金。
四、  雙方權利義務
1.  本協議並無創設雙方任何代理、合夥、經銷、投資、控制、從屬或關係企業關係之效力，乙方非甲方之代辦商，故乙方不得以甲方名義從事業務、利用甲方商標或以其他方式使大眾認知甲方與乙方於商業上有任何關聯性。
2.  乙方承諾在本協議期間不從事任何可能損害甲方聲譽的行為，不以詐欺、不實廣告、違反誠實信用等行為履行本協議，若因乙方上述行為造成甲方直接、間接損害或名譽受損，乙方應賠償甲方因此所受之損害、損失、支出及法律費用。
3.  除甲方明列之費用外，乙方不得藉由與甲方合作關係，向第三人索取額外費用，倘若乙方向第三人額外收取任何費用，概與甲方無涉。

五、  保密義務
1.  乙方對於本協議之內容及因本協議所知悉或持有之甲方營業秘密（包括但不限於公司之技術、財務、策略或行銷規劃等資訊或其他乙方執行本協議所接觸或知悉甲方未對外公開之資訊等），應負保密義務。除依法令規定或依有權機關之要求而對相關主管機關提供者外，不得以任何方式提供或洩露予第三人，亦不得轉作其他目的使用。
2.  於履行契約必要之範圍內，乙方得將甲方之機密資料透露予其員工、代理人或顧問等知悉及處理，但乙方應與其員工、代理人或顧問簽訂與本條保密義務條款內容實質相同之保密契約，若該員工、代理人或顧問違反本條保密約定，視為乙方違反本約款，乙方應同該員工、代理人或顧問對甲方負連帶賠償責任。
3.  乙方或前項所示人員有違反本條約定者，甲方得向乙方請求50萬元之懲罰性違約金；如甲方因此受有損害者，並得另行請求因此所受之損害賠償（含合理律師費用）。
4.  本條保密義務於本協議終止或解除後五年內仍有效。

六、  轉讓 
甲、乙雙方在本協議中之權利及義務，除經他方書面同意外，不得轉讓予任何第三人。

七、  終止合作 
1.  協議任一方欲提前終止本協議，應於一個月前以書面通知他方。
2.  甲方得在下述各款情況，逕行終止本協議，並請求乙方賠償所受損害；因第一款情形終止協議，甲方得不給予乙方獎金：
（1） 乙方以詐欺、哄騙、脅迫或提供不實資訊等不誠實方式履行本協議之業務或違反本協議之雙方權利義務條款、乙方承諾條款或保密義務條款者；
（2） 乙方有重整、清算、解散、合併、暫停營業、受到強制執行等情事；
（3） 乙方違反本協議之任何條款而在甲方書面通知要求限期改善未果者。
（4） 乙方若為自然人而未具有中華民國良民證者。

八、  免責
乙方未能履行本協議之條款或因其違反本協議之任何條款而導致乙方之直接或間接損失、損害、支出、法律費用以及其它責任，甲方概不負責。

九、管轄 
雙方同意本協議由中華民國法律為準據法，關於本協議書如有任何爭議，雙方應依誠信原則協商解決，如有訴訟之必要，雙方同意以台灣台北地方法院為第一審管轄法院。

十、本協議壹式貳份，由雙方各執乙份為憑。

立約人
甲方： 普匯金融科技股份有限公司
代表人：姚木川
地 址：臺北市中山區松江路111號11樓之1

乙方：
代表人： 
地 址：
中華民國                 年               月            日`;

var app = new Vue({
  el: '#page-wrapper',
  data: {
	qrcode_apply_id: 0,
    pagination: {
        current_page: 1,
        last_page: 1,
        per_page: 40,
        total_rows: 1
    },
    searchform: {
        user_id: '',
        sdate: '',
        edate: '',
        alias: 'all',
        current_page: 1
    },
    contract: {
        platform_fee: 0,
        interest: 0,
        collaboration_person: 0,
        collaboration_enterprise: 0
    },
    context: '',
    contract_printing: '',
    data: [],
    is_waiting_response: false,
    mode: 'list'
  },
  filters: {
      asset_amount: function (value) {
        if (value == null) {
            return '-';
        }
        // return value.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',')
		return Number(value).toLocaleString()
      }
  },
  created: function() {

    let params = Object.fromEntries((new URLSearchParams(window.location.search)).entries());
    if (params.user_id) {
        this.searchform.user_id = params.user_id;
    }
    if (params.sdate) {
        this.searchform.sdate = params.sdate;
    }
    if (params.edate) {
        this.searchform.edate = params.edate;
    }
    if (params.alias) {
        this.searchform.alias = params.alias;
    }
    if (params.current_page) {
        this.searchform.current_page = params.current_page;
    }
    this.refresh_data()
  },
  mounted: function() {
    let self = this;

    $('#sdate').datepicker({
        'format': 'yyyy-mm-dd',
    }).on('change', function() { self.searchform.sdate = this.value});

    $('#edate').datepicker({
        'format': 'yyyy-mm-dd',
    }).on('change', function() { self.searchform.edate = this.value});
  },
  computed: {
    is_edit_mode: function () {
        return this.mode == 'edit';
    },
    is_list_mode: function () {
        return this.mode == 'list';
    }
  },
  methods: {
    print_contract: function (apply_id) {
        let self = this;
        self.contract_printing = '';
        this.get_context(apply_id, function (contract) {
            if (contract) {
                self.contract_printing = contract.replace(/\%(\S+)\%/g, function (match, col) {
                    switch (col) {
                        case 'platform_fee':
                        case 'interest':
                        case 'collaboration_person':
                        case 'collaboration_enterprise':
                            return self.contract[col];
                    }
                });
                setTimeout(function () {
                    print();
                }, 300);
            }
        });
    },
    edit_contract: function (apply_id) {
        let self = this;

        this.get_context(apply_id, function (contract) {
            self.mode = 'edit';
            self.context = contract.split(/\%(\S+)\%/g).filter((x, i) => i % 2 == 0);
        });
    },
    cancel: function () {
        this.context = '';
        this.contract = {
            platform_fee: 0,
            interest: 0,
            collaboration_person: 0,
            collaboration_enterprise: 0
        };
        this.mode = 'list';
    },
    change_page: function(page) {
        this.searchform.current_page = page;
        this.search();
    },
	update_contract: async function () {
		this.is_waiting_response = true
		const platform_fee = Number(this.contract.platform_fee)
		const interest = Number(this.contract.interest)
		const collaboration_person = Number(this.contract.collaboration_person)
		const collaboration_enterprise = Number(this.contract.collaboration_enterprise)
		const  qrcode_apply_id  = this.qrcode_apply_id
		if (platform_fee === NaN) {
			alert('服務⼿續費 必須是數字')
			return
		}
		if (interest === NaN) {
			alert('利息⼿續費 必須是數字')
			return
		}
		if (collaboration_person === NaN) {
			alert('第三⽅合作個⼈產品 必須是數字')
			return
		}
		if (collaboration_enterprise === NaN) {
			alert('第三⽅合作企業產品 必須是數字')
			return
		}
		const data = new FormData()
		data.append('qrcode_apply_id',qrcode_apply_id)
		data.append('platform_fee',platform_fee)
		data.append('interest',interest)
		data.append('collaboration_person',collaboration_person)
		data.append('collaboration_enterprise',collaboration_enterprise)
		const res = await axios({
			method:'post',
			url: '/admin/Sales/promote_modify_contract',
			data,
			headers: { 'Content-Type': 'multipart/form-data' },
		})
		this.is_waiting_response = false
		if (res.data.response.result === 'ERROR') {
			alert(res.data.response.msg)
		} else {
			alert('修改成功')
		}
    },
	contract_submit: async function () {
		if (!confirm('確定送出審核？')) {
			return
		}
		this.is_waiting_response = true
		const qrcode_apply_id = this.qrcode_apply_id
		const data = new FormData()
		data.append('qrcode_apply_id',qrcode_apply_id)
		const res = await axios({
			method:'post',
			url: '/admin/Sales/promote_contract_submit',
			data,
			headers: { 'Content-Type': 'multipart/form-data' },
		})
		if (res.data.response.result === 'ERROR') {
			alert(res.data.response.msg)
		} else {
			location.reload()
		}
		this.is_waiting_response = false
	},
    refresh_data: function () {

        var self = this;

        let data = new URLSearchParams(this.searchform).toString();

        axios({
            method: 'get',
            url: '/admin/Sales/promote_apply_list?' + data,
            headers: { 'Accept': 'application/json' }
        }).then(resp => {
            let data = resp.data.response.data;
            self.data = data.list;
            self.pagination = data.pagination;
        })
    },
    search: function () {
        let data = new URLSearchParams(this.searchform).toString();
        location.replace('/admin/Sales/qrcode_projects?' + data);
    },
    get_context: function (apply_id, callback) {
        let self = this;

        let data = new URLSearchParams({
            qrcode_apply_id: apply_id
        }).toString();
		this.qrcode_apply_id = apply_id
        axios({
            method: 'get',
            url: `/admin/Sales/promote_review_contract?${data}`,
            headers: { 'Accept': 'application/json' }
        }).then(resp => {

            var contract = default_context;

            if (resp.data.response.result == 'SUCCESS')
            {
                let data = resp.data.response.data;

                self.contract = {
                    platform_fee: data.content[0],
                    interest: data.content[1],
                    collaboration_person: data.content[2],
                    collaboration_enterprise: data.content[3]
                };

                if (data.contract) {
                    contract = data.contract;
                }
            }
            if (typeof callback !== 'undefined') {
                callback(contract);
            }
            return contract;
        })
    }
  }
})
